<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forja Extrema | Oficial</title>
    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --card: #1e293b; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .card { background: var(--card); padding: 30px; border-radius: 15px; width: 100%; max-width: 400px; border: 1px solid #334155; position: relative; overflow: hidden; }
        h1 { color: var(--primary); text-align: center; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 12px; color: #94a3b8; font-weight: bold; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; outline: none; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; background: var(--primary); color: #0f172a; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-link { background: none; color: var(--primary); text-decoration: underline; font-size: 13px; margin-top: 15px; width: 100%; text-align: center; border: none; cursor: pointer; }
        .hidden { display: none; }
        .status-box { background: #334155; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid var(--primary); }
        
        /* PROVA SOCIAL */
        #prova-social { background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 8px; border-radius: 5px; font-size: 11px; text-align: center; margin-bottom: 15px; border: 1px solid #10b981; display: none; }
        
        /* CRON√îMETRO */
        .timer-container { margin-top: 15px; text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid #475569; }
        #cronometro { font-size: 24px; font-weight: bold; font-family: monospace; }
        .piscando { color: var(--danger) !important; animation: blink 1s infinite; font-size: 28px !important; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .amigo-slot { background: #0f172a; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px dashed #334155; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="card">
    <div id="prova-social"></div>

    <div id="sessao-cadastro">
        <h1>üëë Cadastre-se</h1>
        <p id="info-indicador" style="text-align:center; font-size:11px; margin-bottom:15px; color:#38bdf8"></p>
        <div class="input-group"><label>NOME COMPLETO</label><input type="text" id="reg-nome"></div>
        <div class="input-group"><label>WHATSAPP</label><input type="tel" id="reg-numero" placeholder="19982020202"></div>
        <div class="input-group"><label>CPF</label><input type="text" id="reg-cpf" maxlength="11"></div>
        <button class="btn" onclick="apiCadastrar()">CRIAR MINHA CONTA</button>
        <button class="btn-link" onclick="alternarTela('sessao-login')">J√° sou cadastrado? Entrar</button>
    </div>

    <div id="sessao-login" class="hidden">
        <h1>üîê Entrar</h1>
        <div class="input-group"><label>SEU WHATSAPP</label><input type="tel" id="login-numero"></div>
        <div class="input-group"><label>SUA SENHA</label><input type="password" id="login-senha"></div>
        <button class="btn" onclick="apiLogin()">ACESSAR PAINEL</button>
        <button class="btn-link" onclick="alternarTela('sessao-cadastro')">Voltar</button>
    </div>

    <div id="sessao-painel" class="hidden">
        <h1>√Årea do Membro</h1>
        <div class="status-box">
            <p>Ol√°, <b id="user-nome"></b>!</p>
            <p>Status: <span id="user-status"></span></p>
            <p>Fase Atual: <b id="user-fase"></b></p>
            
            <div id="timer-box" class="timer-container hidden">
                <p style="font-size: 10px; color: #94a3b8; margin-bottom: 5px;">LIMITE PARA FASE (72H):</p>
                <div id="cronometro">--:--:--</div>
            </div>
        </div>

        <div id="area-amigos" class="hidden">
            <h3 style="font-size:14px; margin-bottom:10px; color:#38bdf8">üë• MEUS AMIGOS</h3>
            <div id="slot-amigo1" class="amigo-slot">
                <div id="form-amigo1">
                    <input type="text" id="amigo1-nome" placeholder="Nome do Amigo 1">
                    <input type="tel" id="amigo1-num" placeholder="WhatsApp" style="margin-top:5px">
                    <button class="btn" style="padding:8px; font-size:11px" onclick="cadastrarAmigo(1)">CADASTRAR</button>
                </div>
                <div id="info-amigo1" class="hidden"></div>
            </div>
            <div id="slot-amigo2" class="amigo-slot">
                <div id="form-amigo2">
                    <input type="text" id="amigo2-nome" placeholder="Nome do Amigo 2">
                    <input type="tel" id="amigo2-num" placeholder="WhatsApp" style="margin-top:5px">
                    <button class="btn" style="padding:8px; font-size:11px" onclick="cadastrarAmigo(2)">CADASTRAR</button>
                </div>
                <div id="info-amigo2" class="hidden"></div>
            </div>
        </div>
        <button class="btn-link" onclick="logout()" style="color:var(--danger)">Sair da Conta</button>
    </div>
</div>

<script>
    let timerInterval;
    const urlParams = new URLSearchParams(window.location.search);
    const ref = urlParams.get('ref') || 'direto';
    document.getElementById('info-indicador').innerText = "Indicado por: " + (ref === 'direto' ? "ADMIN" : ref);

    function alternarTela(id) {
        document.querySelectorAll('.card > div:not(#prova-social)').forEach(div => div.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    async function apiLogin() {
        const num = document.getElementById('login-numero').value;
        const senha = document.getElementById('login-senha').value;
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ numero: num, senha: senha })
        });
        const data = await res.json();
        if(data.sucesso) {
            localStorage.setItem('user_forja', num);
            localStorage.setItem('pass_forja', senha);
            montarPainel(data.dados);
        } else alert("Dados incorretos ou usu√°rio removido por tempo.");
    }

    function montarPainel(dados) {
        alternarTela('sessao-painel');
        document.getElementById('user-nome').innerText = dados.nome;
        document.getElementById('user-fase').innerText = dados.fase;
        const st = document.getElementById('user-status');

        if(dados.status === 'ativo') {
            st.innerText = "ATIVO ‚úÖ"; st.style.color = "#10b981";
            document.getElementById('area-amigos').classList.remove('hidden');
            document.getElementById('timer-box').classList.remove('hidden');
            iniciarCronometro(dados.dataAtivacao);
            renderizarAmigos(dados.convidados);
            ativarProvaSocial(dados.fase);
        } else {
            st.innerText = "PENDENTE ‚è≥"; st.style.color = "#f59e0b";
            document.getElementById('timer-box').classList.add('hidden');
        }
    }

    function ativarProvaSocial(fase) {
        const nomes = ["Fabr√≠...", "Jo√£o...", "Marc...", "Carl...", "Brun...", "Rich..."];
        const nums = ["55199", "55119", "55219", "55419"];
        const box = document.getElementById('prova-social');
        
        setInterval(() => {
            const n = nomes[Math.floor(Math.random()*nomes.length)];
            const num = nums[Math.floor(Math.random()*nums.length)];
            box.innerText = `üî• ${n} (${num}****) subiu para a FASE ${parseInt(fase)+1}!`;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 5000);
        }, 15000);
    }

    function iniciarCronometro(dataAtivacao) {
        if (!dataAtivacao) return;
        const fim = new Date(dataAtivacao).getTime() + (72 * 60 * 60 * 1000);
        const display = document.getElementById('cronometro');
        
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const agora = new Date().getTime();
            const dist = fim - agora;

            if (dist < 0) {
                clearInterval(timerInterval);
                display.innerHTML = "EXPIRADO";
                display.classList.add('piscando');
                return;
            }

            const h = Math.floor(dist / (1000 * 60 * 60));
            const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((dist % (1000 * 60)) / 1000);
            display.innerHTML = `${h}h ${m}m ${s}s`;

            if (dist < (24 * 60 * 60 * 1000)) display.classList.add('piscando');
        }, 1000);
    }

    function renderizarAmigos(convidados) {
        [1, 2].forEach(i => {
            const amigo = convidados[i-1];
            if(amigo) {
                document.getElementById(`form-amigo${i}`).classList.add('hidden');
                const info = document.getElementById(`info-amigo${i}`);
                info.classList.remove('hidden');
                info.innerHTML = `<p style="font-size:13px">${amigo.nome}</p>
                    <span class="badge" style="background:${amigo.status==='ativo'?'#10b981':'#f59e0b'}">${amigo.status}</span>`;
            }
        });
    }

    async function apiCadastrar() {
        const res = await fetch('/api/cadastrar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                nome: document.getElementById('reg-nome').value,
                numero: document.getElementById('reg-numero').value,
                cpf: document.getElementById('reg-cpf').value,
                indicadoPor: ref
            })
        });
        const data = await res.json();
        if(data.sucesso) { alert("Cadastrado! Use a senha enviada no seu WhatsApp."); alternarTela('sessao-login'); }
        else alert(data.erro);
    }

    async function cadastrarAmigo(pos) {
        const res = await fetch('/api/cadastrar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                nome: document.getElementById(`amigo${pos}-nome`).value,
                numero: document.getElementById(`amigo${pos}-num`).value,
                cpf: 'OP_' + Math.floor(Math.random()*100000), 
                indicadoPor: localStorage.getItem('user_forja')
            })
        });
        const data = await res.json();
        if(data.sucesso) { alert("Amigo Cadastrado!"); apiLogin(); }
        else alert(data.erro);
    }

    function logout() { localStorage.clear(); location.reload(); }
    window.onload = () => { if(localStorage.getItem('user_forja')) apiLogin(); }
</script>
</body>
</html>