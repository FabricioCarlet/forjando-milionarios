<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Master Admin | Forja Extrema</title>
    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: var(--card); height: 100vh; padding: 20px; border-right: 1px solid #334155; position: fixed; }
        .sidebar h2 { color: var(--primary); margin-bottom: 30px; font-size: 20px; text-align: center; }
        .nav-btn { width: 100%; padding: 12px; background: transparent; border: none; color: var(--text); text-align: left; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; }
        .nav-btn:hover, .nav-btn.active { background: var(--primary); color: var(--bg); font-weight: bold; }

        /* Main Content */
        .main { margin-left: 250px; padding: 40px; width: 100%; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; text-align: center; }
        .stat-card h3 { font-size: 14px; color: #94a3b8; }
        .stat-card p { font-size: 24px; color: var(--primary); font-weight: bold; }

        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #334155; color: var(--primary); font-size: 12px; text-transform: uppercase; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-pendente { background: #f59e0b22; color: #f59e0b; }
        .badge-ativo { background: #10b98122; color: #10b981; }

        .btn-action { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px; }
        .btn-activate { background: #10b981; color: white; }
        .btn-msg { background: var(--primary); color: white; }
        .btn-reset { background: #ef4444; color: white; }

        .modal { background: rgba(0,0,0,0.8); position: fixed; top:0; left:0; width:100%; height:100%; display:none; justify-content:center; align-items:center; }
        .modal-content { background: var(--card); padding: 30px; border-radius: 15px; width: 400px; }
        textarea { width: 100%; background: var(--bg); color: white; padding: 10px; border-radius: 8px; margin-top: 10px; height: 100px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>üõ† FORJA ADMIN</h2>
    <button class="nav-btn active" onclick="showTab('tab-listar')">üë• Listar Usu√°rios</button>
    <button class="nav-btn" onclick="showTab('tab-fases')">üÜô Gest√£o de Fases</button>
    <button class="nav-btn" onclick="openBroadcast()">üì¢ Aviso Coletivo</button>
    <button class="nav-btn" onclick="resetSistema()" style="color: #ef4444;">‚ö†Ô∏è Reset Total</button>
    <div style="margin-top: 50px; font-size: 10px; color: #94a3b8; text-align: center;">
        Comandos via WhatsApp Ativos ‚úÖ
    </div>
</div>

<div class="main">
    <div class="stats-grid">
        <div class="stat-card"><h3>Total Membros</h3><p id="stat-total">0</p></div>
        <div class="stat-card"><h3>Ativos</h3><p id="stat-ativos" style="color: #10b981">0</p></div>
        <div class="stat-card"><h3>Pendentes</h3><p id="stat-pendentes" style="color: #f59e0b">0</p></div>
    </div>

    <div id="tab-listar">
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>WhatsApp</th>
                    <th>Pai (Indicador)</th>
                    <th>Filhos</th>
                    <th>Status</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="lista-usuarios"></tbody>
        </table>
    </div>
</div>

<div id="modalMsg" class="modal">
    <div class="modal-content">
        <h3>Enviar Mensagem</h3>
        <p id="msg-destino" style="font-size: 12px; color: var(--primary)"></p>
        <textarea id="texto-msg" placeholder="Digite sua mensagem..."></textarea>
        <button class="btn-action btn-msg" style="width:100%; margin-top:15px; padding:12px" onclick="enviarMensagem()">ENVIAR VIA WHATSAPP</button>
        <button class="btn-action" style="width:100%; margin-top:5px" onclick="closeModal()">CANCELAR</button>
    </div>
</div>

<script>
    let usuariosGlobal = [];
    let destinoAtual = ""; 
    // Defini a senha em uma constante para facilitar a manuten√ß√£o
    const ADMIN_AUTH = { 'x-admin-pass': 'Fa76Ca22120929' };

    async function carregarDados() {
        try {
            const res = await fetch('/api/admin/listar', {
                headers: ADMIN_AUTH
            });
            if (!res.ok) throw new Error("Erro de autentica√ß√£o");
            const dados = await res.json();
            usuariosGlobal = dados;
            renderizar();
        } catch (err) {
            console.error("Erro ao carregar dados:", err.message);
        }
    }

    function renderizar() {
        const corpo = document.getElementById('lista-usuarios');
        corpo.innerHTML = "";
        
        let ativos = 0;
        usuariosGlobal.forEach(u => {
            if(u.status === 'ativo') ativos++;
            const numLimpo = u.numero.split('@')[0];
            const filhos = usuariosGlobal.filter(f => f.indicadoPor.includes(numLimpo)).length;

            corpo.innerHTML += `
                <tr>
                    <td>${u.nome}</td>
                    <td>${numLimpo}</td>
                    <td>${u.indicadoPor.split('@')[0]}</td>
                    <td>${filhos}/2</td>
                    <td><span class="badge badge-${u.status}">${u.status.toUpperCase()}</span></td>
                    <td>
                        ${u.status === 'pendente' ? `<button class="btn-action btn-activate" onclick="acaoAtivar('${numLimpo}')">Ativar</button>` : ''}
                        <button class="btn-action btn-msg" onclick="openMsg('${numLimpo}')">Avisar</button>
                        <button class="btn-action btn-reset" onclick="acaoRemover('${numLimpo}')">Excluir</button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('stat-total').innerText = usuariosGlobal.length;
        document.getElementById('stat-ativos').innerText = ativos;
        document.getElementById('stat-pendentes').innerText = usuariosGlobal.length - ativos;
    }

    async function acaoAtivar(num) {
        if(!confirm(`Ativar ${num}?`)) return;
        await fetch('/api/admin/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...ADMIN_AUTH },
            body: JSON.stringify({ numero: num, status: 'ativo' })
        });
        carregarDados();
    }

    async function acaoRemover(num) {
        if(!confirm(`Excluir definitivamente ${num}?`)) return;
        await fetch('/api/admin/remover', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...ADMIN_AUTH },
            body: JSON.stringify({ numero: num })
        });
        carregarDados();
    }

    function openMsg(num) {
        destinoAtual = num;
        document.getElementById('msg-destino').innerText = num === 'all' ? "AVISO COLETIVO" : "Para: " + num;
        document.getElementById('modalMsg').style.display = 'flex';
    }

    function openBroadcast() { openMsg('all'); }
    function closeModal() { document.getElementById('modalMsg').style.display = 'none'; }

    async function enviarMensagem() {
        const txt = document.getElementById('texto-msg').value;
        await fetch('/api/admin/avisar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...ADMIN_AUTH },
            body: JSON.stringify({ para: destinoAtual, mensagem: txt })
        });
        alert("Mensagem enviada!");
        closeModal();
    }

    async function resetSistema() {
        if(confirm("‚ö†Ô∏è RESET TOTAL? Isso apagar√° tudo!")) {
            await fetch('/api/admin/reset', { 
                method: 'POST',
                headers: ADMIN_AUTH 
            });
            carregarDados();
        }
    }

    setInterval(carregarDados, 5000); 
    carregarDados();
</script>
</body>
</html>